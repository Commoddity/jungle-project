/* malevic@0.16.3 - Jul 22, 2019 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e(((t=t||self).Malevic=t.Malevic||{},t.Malevic.DOM={}))}(this,function(t){"use strict";function e(){var i=[];return{add:function(t){return i.push(t),this},apply:function(t){for(var e,n,r=new Set,o=i.length-1;0<=o;o--)if(n=i[o],!r.has(n)){if(null!=(e=n(t)))return e;r.add(n)}return null},delete:function(t){for(var e=i.length-1;0<=e;e--)if(i[e]===t){i.splice(e,1);break}return this},empty:function(){return 0===i.length}}}function n(r,t,o){t.filter(function(t){var e=t[0];return r[e]}).forEach(function(t){var e=t[0],n=t[1];return r[e].forEach(function(t){return o(n,t)})})}function r(n){var r={add:function(t,e){return t[n]||(t[n]=[]),t[n].push(e),r}};return r}var o=Symbol(),i=e();function c(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var n=[];return t.filter(function(t){return Boolean(t)}).forEach(function(e){"string"==typeof e?n.push(e):"object"==typeof e&&n.push.apply(n,Object.keys(e).filter(function(t){return Boolean(e[t])}))}),n.join(" ")}function p(t){return null!=t&&"object"==typeof t}var f=new WeakMap;function u(e,t){var n=new Map,r=new Set(Object.keys(e));return Object.keys(t).filter(function(t){return!r.has(t)}).forEach(function(t){return n.set(t,null)}),r.forEach(function(t){return n.set(t,e[t])}),n}function h(n,t,e){var r;p(e)?r=e:(r={},n.removeAttribute("style")),u(t,r).forEach(function(t,e){return function(t,e,n){if(null!=n&&""!==n){var r=String(n),o="";r.endsWith("!important")&&(r=r.substring(0,r.length-10),o="important"),t.style.setProperty(e,r,o)}else t.style.removeProperty(e)}(n,e,t)})}function l(t,e,n){var r,o,i,u,s,a,c;"function"==typeof n?(u=t,s=e,a=n,f.has(u)?c=f.get(u):(c=new Map,f.set(u,c)),c.get(s)!==a&&(c.has(s)&&u.removeEventListener(s,c.get(s)),u.addEventListener(s,a),c.set(s,a))):(r=t,o=e,i=f.get(r),r.removeEventListener(o,i.get(o)),i.delete(o))}var d=new Set(["key","attached","detached","updated"]),s=Symbol(),v=e();function y(t,e){return t&&t.hasOwnProperty(e)?t[e]:null}function a(s,t,a){u(t,a||{}).forEach(function(t,e){var n,r,o;if(!v.empty()&&null!=v.apply({element:s,attr:e,value:t,get prev(){return y(a,e)}}))return;if("class"===e&&p(t))n=s,r=t,(o=Array.isArray(r)?c.apply(void 0,r):c(r))?n.setAttribute("class",o):n.removeAttribute("class");else if("style"===e&&p(t)){var i=y(a,e);h(s,t,i)}else if(e.startsWith("on")){var u=e.substring(2);l(s,u,t)}else d.has(e)||(null==t||!1===t?s.removeAttribute(e):s.setAttribute(e,!0===t?"":String(t)))})}var g=function(){function t(){for(var e=this,t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];this.nexts=new WeakMap,this.prevs=new WeakMap,this.first=null,this.last=null,t.forEach(function(t){return e.push(t)})}return t.prototype.empty=function(){return null==this.first},t.prototype.push=function(t){this.empty()?this.first=t:(this.nexts.set(this.last,t),this.prevs.set(t,this.last)),this.last=t},t.prototype.insertBefore=function(t,e){var n=this.before(e);this.prevs.set(t,n),this.nexts.set(t,e),this.prevs.set(e,t),n&&this.nexts.set(n,t),e===this.first&&(this.first=t)},t.prototype.delete=function(t){var e=this.before(t),n=this.after(t);e&&this.nexts.set(e,n),n&&this.prevs.set(n,e),t===this.first&&(this.first=n),t===this.last&&(this.last=e)},t.prototype.before=function(t){return this.prevs.get(t)||null},t.prototype.after=function(t){return this.nexts.get(t)||null},t.prototype.loop=function(t){if(!this.empty()){var e=this.first;do{if(t(e))break}while(e=this.after(e))}},t.prototype.copy=function(){var e=new t;return this.loop(function(t){return e.push(t),!1}),e},t.prototype.forEach=function(e){this.loop(function(t){return e(t),!1})},t.prototype.find=function(e){var n=null;return this.loop(function(t){return!!e(t)&&(n=t,!0)}),n},t.prototype.map=function(e){var n=[];return this.loop(function(t){return n.push(e(t)),!1}),n},t}();function m(t,e,n){var r=t&&e&&t.matches(e);r&&t.parent()===e.parent()?n.replaceVNode(e,t):t&&n.addVNode(t);var o=n.getVNodeContext(t),i=n.getVNodeContext(e);if((e&&!r&&(e.detach(i),e.children().forEach(function(t){return m(null,t,n)}),e.detached(i)),t&&!r&&(t.attach(o),t.children().forEach(function(t){return m(t,null,n)}),t.attached(o)),r)&&t.update(e,o)!==n.LEAVE){var u=function(t,e){var n=e.children(),o=new Map,i=[];n.forEach(function(t){var e=t.key();null==e?i.push(t):o.set(e,t)});var r=t.children(),u=[],s=new Set(n),a=new Set;return r.forEach(function(t){var e=null,n=null,r=t.key();if(null!=r){if(a.has(r))throw new Error("Duplicate key");a.add(r),o.has(r)&&(n=o.get(r))}else 0<i.length&&(n=i.shift());t.matches(n)&&(e=n),u.push([t,e]),e&&s.delete(e)}),{matches:u,unmatched:s}}(t,e),s=u.matches;u.unmatched.forEach(function(t){return m(null,t,n)}),s.forEach(function(t){return m(t[0],t[1],n)}),t.updated(o)}}var E=function(t,e){return(E=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)};function w(t,e){function n(){this.constructor=t}E(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}function x(t){return p(t)&&null!=t.type&&null==t.nodeType}var b=function(){function t(t){this.parentVNode=t}return t.prototype.key=function(){return null},t.prototype.parent=function(t){if(!t)return this.parentVNode;this.parentVNode=t},t.prototype.children=function(){return[]},t.prototype.attach=function(t){},t.prototype.detach=function(t){},t.prototype.update=function(t,e){return null},t.prototype.attached=function(t){},t.prototype.detached=function(t){},t.prototype.updated=function(t){},t}();function N(t,e){return t instanceof Element&&e.type===t.tagName.toLowerCase()}var k=new WeakMap;function C(t,e){var n;k.has(e)?n=k.get(e):(n=new WeakSet,k.set(e,n)),n.add(t)}function A(t,e){return k.has(e)&&k.get(e).has(t)}var V=function(r){function e(t,e){var n=r.call(this,e)||this;return n.spec=t,n}return w(e,r),e.prototype.matches=function(t){return t instanceof e&&this.spec.type===t.spec.type},e.prototype.key=function(){return this.spec.props.key},e.prototype.children=function(){return[this.child]},e.prototype.getExistingElement=function(t){var e,n=t.parent,r=t.node;if(N(r,this.spec))e=r;else if(!A(n,t.vdom)&&t.vdom.isDOMNodeCaptured(n)){var o=t.sibling,i=o?o.nextElementSibling:n.firstElementChild;i&&!t.vdom.isDOMNodeCaptured(i)&&(N(i,this.spec)?e=i:n.removeChild(i))}return e},e.prototype.attach=function(t){var e,n=this.getExistingElement(t);n?e=n:C(e=function(t,e){var n=i.apply({spec:t,parent:e});if(n)return n;var r=t.type;return"svg"===r?document.createElementNS("http://www.w3.org/2000/svg","svg"):"http://www.w3.org/1999/xhtml"===e.namespaceURI?document.createElement(r):document.createElementNS(e.namespaceURI,r)}(this.spec,t.parent),t.vdom),a(e,this.spec.props,null),this.child=L(e,this.spec.children,this)},e.prototype.update=function(t,e){var n=e.vdom.getVNodeContext(t).node;a(n,this.spec.props,t.spec.props),this.child=L(n,this.spec.children,this)},e.prototype.attached=function(t){var e=this.spec.props.attached;e&&e(t.node)},e.prototype.detached=function(t){var e=this.spec.props.detached;e&&e(t.node)},e.prototype.updated=function(t){var e=this.spec.props.updated;e&&e(t.node)},e}(b),S={ATTACHED:Symbol(),DETACHED:Symbol(),UPDATED:Symbol()},D=[[o,i],[s,v]],M=function(r){function u(t,e){var n=r.call(this,e)||this;return n.lock=!1,n.spec=t,n.prev=null,n.store={},n}return w(u,r),u.prototype.matches=function(t){return t instanceof u&&this.spec.type===t.spec.type},u.prototype.key=function(){return this.spec.props.key},u.prototype.children=function(){return[this.child]},u.prototype.createContext=function(r){var o=this,t=r.parent,e=this.spec,n=this.prev,i=this.store;return{spec:e,prev:n,store:i,get node(){return r.node},get nodes(){return r.nodes},parent:t,attached:function(t){return i[S.ATTACHED]=t},detached:function(t){return i[S.DETACHED]=t},updated:function(t){return i[S.UPDATED]=t},refresh:function(){if(o.lock)throw new Error("Calling refresh during unboxing causes infinite loop");o.prev=o.spec;var t=r.vdom.getVNodeContext(o),e=o.unbox(t);if(e!==r.vdom.LEAVE){var n=o.child;o.child=B(e,o),r.vdom.execute(o.child,n)}},leave:function(){return r.vdom.LEAVE}}},u.prototype.unbox=function(t){var e=this.spec.type,n=this.spec.props,r=this.spec.children;this.lock=!0;var o=u.context;u.context=this.createContext(t);var i=null;try{i=e.apply(void 0,[n].concat(r))}finally{u.context=o,this.lock=!1}return i},u.prototype.addPlugins=function(){n(this.spec.type,D,function(t,e){return t.add(e)})},u.prototype.deletePlugins=function(){n(this.spec.type,D,function(t,e){return t.delete(e)})},u.prototype.attach=function(t){this.addPlugins();var e=this.unbox(t),n=e===t.vdom.LEAVE?null:e;this.child=B(n,this)},u.prototype.update=function(t,e){this.store=t.store,this.prev=t.spec;var n=e.vdom.getVNodeContext(t);this.addPlugins();var r=this.unbox(n),o=null;return r===e.vdom.LEAVE?(o=r,this.child=t.child,e.vdom.adoptVNode(this.child,this)):this.child=B(r,this),o},u.prototype.handle=function(t,e){var n=this.store[t];if(n){var r=0===e.nodes.length?[null]:e.nodes;n.apply(void 0,r)}},u.prototype.attached=function(t){this.deletePlugins(),this.handle(S.ATTACHED,t)},u.prototype.detached=function(t){this.handle(S.DETACHED,t)},u.prototype.updated=function(t){this.deletePlugins(),this.handle(S.UPDATED,t)},u.context=null,u}(b);var O=function(r){function e(t,e){var n=r.call(this,e)||this;return n.text=t,n}return w(e,r),e.prototype.matches=function(t){return t instanceof e},e.prototype.children=function(){return[this.child]},e.prototype.getExistingNode=function(t){var e,n=t.parent;if(t.node instanceof Text)e=t.node;else if(!A(n,t.vdom)&&t.vdom.isDOMNodeCaptured(n)){var r=t.sibling,o=r?r.nextSibling:n.firstChild;o&&!t.vdom.isDOMNodeCaptured(o)&&o instanceof Text&&(e=o)}return e},e.prototype.attach=function(t){var e,n=this.getExistingNode(t);n?(e=n).textContent=this.text:e=document.createTextNode(this.text),this.child=B(e,this)},e.prototype.update=function(t,e){var n=e.vdom.getVNodeContext(t).node;this.text!==t.text&&(n.textContent=this.text),this.child=B(n,this)},e}(b),T=function(r){function e(t,e){var n=r.call(this,e)||this;return n.fn=t,n}return w(e,r),e.prototype.matches=function(t){return t instanceof e},e.prototype.children=function(){return[this.child]},e.prototype.call=function(t){var e=(0,this.fn)({parent:t.parent,get node(){return t.node},get nodes(){return t.nodes}});this.child=B(e,this)},e.prototype.attach=function(t){this.call(t)},e.prototype.update=function(t,e){var n=e.vdom.getVNodeContext(t);this.call(n)},e}(b),P=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return w(e,t),e.prototype.matches=function(t){return t instanceof e},e}(b),W=function(o){function e(t,e,n){var r=o.call(this,n)||this;return r.node=t,r.childSpecs=e,r}return w(e,o),e.prototype.matches=function(t){return t instanceof e&&this.node===t.node},e.prototype.wrap=function(){var e=this;this.childVNodes=this.childSpecs.map(function(t){return B(t,e)})},e.prototype.insertNode=function(t){var e=t.parent,n=t.sibling;if(!(e===this.node.parentElement&&n===this.node.previousSibling)){var r=n?n.nextSibling:e.firstChild;e.insertBefore(this.node,r)}},e.prototype.attach=function(t){this.wrap(),this.insertNode(t)},e.prototype.detach=function(t){t.parent.removeChild(this.node)},e.prototype.update=function(t,e){this.wrap(),this.insertNode(e)},e.prototype.refine=function(t){for(var e=this.node,n=e.lastChild;null!=n;)if(t.vdom.isDOMNodeCaptured(n))n=n.previousSibling;else{var r=n.previousSibling;e.removeChild(n),n=r}C(e,t.vdom)},e.prototype.attached=function(t){var e=this.node;e instanceof Element&&!A(e,t.vdom)&&t.vdom.isDOMNodeCaptured(e)&&this.refine(t)},e.prototype.children=function(){return this.childVNodes},e}(b);function j(t){return t instanceof W}function L(t,e,n){return new W(t,e,n)}var _=function(o){function e(t,e,n){var r=o.call(this,n)||this;return r.items=t,r.id=e,r}return w(e,o),e.prototype.matches=function(t){return t instanceof e},e.prototype.key=function(){return this.id},e.prototype.children=function(){return this.childVNodes},e.prototype.wrap=function(){var e=this;this.childVNodes=this.items.map(function(t){return B(t,e)})},e.prototype.attach=function(){this.wrap()},e.prototype.update=function(){this.wrap()},e}(b);function B(t,e){if(x(n=t)&&"string"==typeof n.type)return new V(t,e);var n,r;if(x(r=t)&&"function"==typeof r.type)return t.type===Array?new _(t.children,t.props.key,e):new M(t,e);if("string"==typeof t)return new O(t,e);if(null==t)return new P(e);if("function"==typeof t)return new T(t,e);if(t instanceof Node)return L(t,[],e);if(Array.isArray(t))return new _(t,null,e);throw new Error("Unable to create virtual node for spec")}function H(o){var u=new WeakMap,s=new WeakMap,a=new WeakMap,c=new WeakMap,p=new WeakSet;function f(n){var r=a.get(n);u.set(n,{parent:r,get node(){var t=c.get(n).find(function(t){return null!=t.node});return t?t.node:null},get nodes(){return c.get(n).map(function(t){return t.node}).filter(function(t){return t})},get sibling(){if(r===o.parentElement)return c.get(n).first.node.previousSibling;for(var t=s.get(r),e=c.get(n).first;e=t.links.before(e);)if(e.node)return e.node;return null},vdom:i})}function h(t){var e,n,r;null==t.parent()?(e=t,n=o.parentElement||document.createDocumentFragment(),r=new g({parentNode:n,node:o}),c.set(e,r.copy()),a.set(e,n),s.set(n,{node:n,links:r})):function(t){var e=t.parent(),n=p.has(e),r=j(e)?e.node:a.get(e);a.set(t,r);var o=new g;if(c.set(t,o),n){for(var i={parentNode:r,node:null},u=t;c.get(u).push(i),(u=u.parent())&&!j(u););s.get(r).links.push(i)}else p.add(e),(j(e)?s.get(r).links:c.get(e)).forEach(function(t){return o.push(t)})}(t),function(t){if(j(t)){var e=t.node;s.set(e,{node:e,links:new g({parentNode:e,node:null})}),c.get(t).forEach(function(t){return t.node=e})}}(t),f(t)}function l(t){for(var e=a.get(t),n=s.get(e),r=[],o=t;(o=o.parent())&&!j(o);)r.push(c.get(o));return r.push(n.links),r}var i={execute:function(t,e){m(t,e,i)},addVNode:h,getVNodeContext:function(t){return u.get(t)},replaceVNode:function(t,e){if(null!=e.parent()){var n=u.get(t).parent;a.set(e,n);var r=c.get(t),o={parentNode:n,node:null};l(e).forEach(function(e){var t=e.after(r.last);r.forEach(function(t){return e.delete(t)}),t?e.insertBefore(o,t):e.push(o)});var i=new g(o);c.set(e,i),f(e)}else h(e)},adoptVNode:function(t,e){var n=c.get(t),r=c.get(e).copy();t.parent(e),l(t).forEach(function(e){n.forEach(function(t){return e.insertBefore(t,r.first)}),r.forEach(function(t){return e.delete(t)})})},isDOMNodeCaptured:function(t){return s.has(t)&&t!==o.parentElement},LEAVE:Symbol()};return i}var U=new WeakMap,I=new WeakMap;function R(t,e){var n,r=U.get(t)||null;return U.set(t,e),I.has(t)?n=I.get(t):(n=H(t),I.set(t,n)),n.execute(e,r),n.getVNodeContext(e)}var F={createElement:r(o),setAttribute:r(s)};t.getContext=function(){return M.context},t.plugins=F,t.render=function(t,e){return R(t,L(t,Array.isArray(e)?e:[e],null)),t},t.sync=function(t,e){var n=R(t,B(e,null)).nodes;if(1!==n.length||n[0]!==t)throw new Error("Spec does not match the node");return n[0]},t.teardown=function(t){U.delete(t),I.delete(t)},Object.defineProperty(t,"__esModule",{value:!0})});
